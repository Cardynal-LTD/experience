<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Experience - Article</title>
  <meta name="description" content="">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/main.css">
</head>
<body>
  <header class="header">
    <div class="header__content">
      <a href="/" class="header__logo">Experience</a>
      <nav class="header__nav">
        <a href="/" class="header__nav-link">Home</a>
        <a href="/archive.html" class="header__nav-link">Archive</a>
        <a href="/about.html" class="header__nav-link">About</a>
      </nav>
      <button class="btn btn--ghost btn--icon" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
        <svg class="moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
    </div>
  </header>

  <main class="main main--full" id="mainContent">
    <div class="page">
      <div class="empty-state animate-pulse">
        <div class="empty-state__title">Chargement de l'article...</div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer__content">
      <p class="footer__text">Experience Blog</p>
      <div class="footer__links">
        <a href="/" class="footer__link">Home</a>
        <a href="/archive.html" class="footer__link">Archive</a>
        <a href="/about.html" class="footer__link">About</a>
        <a href="/rss.xml" class="footer__link">RSS</a>
      </div>
    </div>
  </footer>

  <script type="module">
    import './js/theme.js'
    import { marked } from 'marked'

    marked.setOptions({ breaks: true, gfm: true })

    async function loadArticle() {
      const main = document.getElementById('mainContent')
      const slug = window.location.pathname.split('/').pop()

      try {
        const res = await fetch(`/api/articles/${slug}`)

        if (!res.ok) {
          showError()
          return
        }

        const article = await res.json()

        document.title = `Experience - ${article.title}`
        document.querySelector('meta[name="description"]').content =
          article.content.substring(0, 160).replace(/[#*_`]/g, '') + '...'

        const contentHtml = marked.parse(article.content)

        main.innerHTML = `
          <article class="page animate-fadeIn">
            ${article.cover_image ? `
              <div class="article-cover">
                <img src="${article.cover_image}" alt="" class="article-cover__image">
              </div>
            ` : ''}
            <div class="article-header">
              ${article.emoji ? `<div class="article-header__emoji">${article.emoji}</div>` : ''}
              <h1 class="article-header__title">${escapeHtml(article.title)}</h1>
              <div class="article-header__meta">
                <span>Publie le ${formatDate(article.created_at)}</span>
                ${article.updated_at && article.updated_at !== article.created_at ?
                  `<span>Mis a jour le ${formatDate(article.updated_at)}</span>` : ''}
                ${article.tags ? `<span class="tag">${escapeHtml(article.tags)}</span>` : ''}
              </div>
            </div>
            <div class="article-content prose">
              ${contentHtml}
            </div>
            <div style="margin-top: var(--space-12); padding-top: var(--space-6); border-top: 1px solid var(--border-default);">
              <a href="/archive.html" class="btn btn--ghost">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Retour aux archives
              </a>
            </div>
          </article>
        `

      } catch (err) {
        showError()
      }
    }

    function showError() {
      const main = document.getElementById('mainContent')
      main.innerHTML = `
        <div class="page animate-fadeIn">
          <div class="empty-state">
            <div class="empty-state__icon">üîç</div>
            <div class="empty-state__title">Article non trouve</div>
            <div class="empty-state__description">Cet article n'existe pas ou a ete supprime.</div>
            <a href="/archive.html" class="btn btn--primary" style="margin-top: var(--space-4);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Retour aux archives
            </a>
          </div>
        </div>
      `
    }

    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr)
      return date.toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      })
    }

    loadArticle()
  </script>
</body>
</html>
