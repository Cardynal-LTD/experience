<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Experience - Article</title>
  <meta name="description" content="">
  <meta name="author" content="Experience">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1">
  <link rel="canonical" href="">

  <!-- Open Graph (dynamically updated) -->
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="Experience">
  <meta property="og:locale" content="fr_FR">
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="article:published_time" content="">
  <meta property="article:modified_time" content="">

  <!-- Twitter Cards (dynamically updated) -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="">

  <!-- Theme -->
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0a0a0a" media="(prefers-color-scheme: dark)">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/main.css">

  <!-- JSON-LD (dynamically injected) -->
  <script type="application/ld+json" id="articleSchema"></script>
</head>
<body>
  <header class="header">
    <div class="header__content">
      <a href="/" class="header__logo">Cardynal</a>
      <nav class="header__nav">
        <a href="/" class="header__nav-link" data-i18n="nav.home">Accueil</a>
        <a href="/blog.html" class="header__nav-link">Blog</a>
        <a href="/archive.html" class="header__nav-link" data-i18n="nav.archive">Archive</a>
      </nav>
      <div class="header__actions">
        <button class="btn btn--ghost btn--icon" onclick="toggleTheme()" aria-label="Toggle theme">
          <svg class="sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
          </svg>
          <svg class="moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="main main--full" id="mainContent">
    <div class="page">
      <div class="empty-state animate-pulse">
        <div class="empty-state__title">Chargement de l'article...</div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer__content">
      <p class="footer__text">Cardynal Blog</p>
      <div class="footer__links">
        <a href="/" class="footer__link" data-i18n="nav.home">Accueil</a>
        <a href="/blog.html" class="footer__link">Blog</a>
        <a href="/archive.html" class="footer__link" data-i18n="nav.archive">Archive</a>
        <a href="/rss.xml" class="footer__link" data-i18n="nav.rss">RSS</a>
      </div>
    </div>
  </footer>

  <script type="module">
    import './js/theme.js'
    import { initAuth } from './js/auth.js'
    import { initLangSelector, getCurrentLang, addHreflangTags, getLangPrefix, updateNavLinks, t } from './js/i18n.js'
    import { marked } from 'marked'

    initAuth()
    initLangSelector()

    const currentLang = getCurrentLang()

    marked.setOptions({ breaks: true, gfm: true })

    async function loadArticle() {
      const main = document.getElementById('mainContent')
      const slug = window.location.pathname.split('/').pop()

      try {
        const res = await fetch(`/api/articles/${slug}`)

        if (!res.ok) {
          showError()
          return
        }

        const article = await res.json()

        const siteUrl = window.location.origin
        const articleUrl = `${siteUrl}/article/${article.slug}`
        const description = article.content.substring(0, 160).replace(/[#*_`\n]/g, ' ').trim() + '...'
        const coverImage = article.cover_image || `${siteUrl}/og-image.jpg`

        // Update document title
        document.title = `${article.title} - Experience`

        // Update meta tags
        document.querySelector('meta[name="description"]').content = description
        document.querySelector('link[rel="canonical"]').href = articleUrl

        // Open Graph
        document.querySelector('meta[property="og:title"]').content = article.title
        document.querySelector('meta[property="og:description"]').content = description
        document.querySelector('meta[property="og:url"]').content = articleUrl
        document.querySelector('meta[property="og:image"]').content = coverImage
        document.querySelector('meta[property="article:published_time"]').content = article.created_at
        document.querySelector('meta[property="article:modified_time"]').content = article.updated_at || article.created_at

        // Twitter Cards
        document.querySelector('meta[name="twitter:title"]').content = article.title
        document.querySelector('meta[name="twitter:description"]').content = description
        document.querySelector('meta[name="twitter:image"]').content = coverImage

        // JSON-LD Article Schema
        document.getElementById('articleSchema').textContent = JSON.stringify({
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": article.title,
          "description": description,
          "image": coverImage,
          "datePublished": article.created_at,
          "dateModified": article.updated_at || article.created_at,
          "mainEntityOfPage": articleUrl,
          "inLanguage": article.lang || "fr",
          "author": {
            "@type": "Person",
            "name": "Experience"
          },
          "publisher": {
            "@type": "Organization",
            "name": "Experience",
            "url": siteUrl
          }
        })

        // Fetch translations for hreflang tags
        try {
          const transRes = await fetch(`/api/articles/${slug}/translations`)
          const translations = await transRes.json()
          addHreflangTags(translations)
        } catch (e) {
          addHreflangTags([])
        }

        const contentHtml = marked.parse(article.content)

        main.innerHTML = `
          <article class="page page--article animate-fadeIn">
            <div class="article-hero ${article.cover_image ? 'has-cover' : ''}">
              ${article.cover_image ? `
                <div class="article-hero__cover">
                  <img src="${article.cover_image}" alt="${escapeHtml(article.title)}" class="article-hero__image" loading="eager" decoding="async">
                </div>
              ` : ''}
              <div class="article-hero__emoji">${article.emoji || 'üìÑ'}</div>
            </div>
            <div class="article-header">
              <h1 class="article-header__title">${escapeHtml(article.title)}</h1>
              <div class="article-header__meta">
                <span>Publie le ${formatDate(article.created_at)}</span>
                ${article.updated_at && article.updated_at !== article.created_at ?
                  `<span>Mis a jour le ${formatDate(article.updated_at)}</span>` : ''}
                ${article.tags ? `<span class="tag">${escapeHtml(article.tags)}</span>` : ''}
              </div>
            </div>
            <div class="article-content prose">
              ${contentHtml}
            </div>
            <div style="margin-top: var(--space-12); padding-top: var(--space-6); border-top: 1px solid var(--border-default);">
              <a href="/archive.html" class="btn btn--ghost">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                ${t('article.backToArchive')}
              </a>
            </div>
          </article>
        `
        updateNavLinks()

      } catch (err) {
        showError()
      }
    }

    function showError() {
      const main = document.getElementById('mainContent')
      main.innerHTML = `
        <div class="page animate-fadeIn">
          <div class="empty-state">
            <div class="empty-state__icon">üîç</div>
            <div class="empty-state__title">${t('article.notFound')}</div>
            <div class="empty-state__description">${t('article.notFoundDesc')}</div>
            <a href="/archive.html" class="btn btn--primary" style="margin-top: var(--space-4);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              ${t('article.backToArchive')}
            </a>
          </div>
        </div>
      `
      updateNavLinks()
    }

    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr)
      return date.toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      })
    }

    loadArticle()
  </script>
</body>
</html>
