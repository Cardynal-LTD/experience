<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article - Cardynal</title>
  <meta name="description" content="">
  <meta name="author" content="Cardynal">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="">

  <!-- Open Graph (dynamically updated) -->
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="Cardynal">
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <meta property="article:published_time" content="">
  <meta property="article:modified_time" content="">

  <!-- Twitter Cards (dynamically updated) -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="">

  <!-- Theme -->
  <meta name="theme-color" content="#020917">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/logo-cardynal.png">
  <link rel="manifest" href="/manifest.json">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro:wght@400;700&family=Libre+Baskerville:wght@400;700&family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./css/main.css">
  <link rel="stylesheet" href="./css/landing/index.css">

  <!-- JSON-LD (dynamically injected) -->
  <script type="application/ld+json" id="articleSchema"></script>
</head>
<body class="landing-page">
  <!-- Header injected by JS -->
  <div id="header-container"></div>

  <main class="article-page-content" id="mainContent">
    <div class="article-page-content__inner">
      <div style="text-align: center; padding: 3rem; color: var(--landing-text-muted);">
        Loading article...
      </div>
    </div>
  </main>

  <!-- Footer injected by JS -->
  <div id="footer-container"></div>

  <script type="module">
    import { renderHeader, initHeader } from '/js/components/header.js'
    import { renderFooter } from '/js/components/footer.js'
    import { initLangSelector, getCurrentLang, setLang, addHreflangTags, translatePage, t } from '/js/i18n.js'
    import { marked } from 'marked'

    // Inject header and footer
    document.getElementById('header-container').innerHTML = renderHeader({ activePage: 'blog' })
    document.getElementById('footer-container').innerHTML = renderFooter()

    // Initialize
    initHeader()
    initLangSelector()
    translatePage()

    // Expose setLang globally
    window.setLang = setLang

    // Theme from localStorage
    const savedTheme = localStorage.getItem('theme')
    if (savedTheme === 'light') {
      document.body.classList.add('light-mode')
    }

    const currentLang = getCurrentLang()

    marked.setOptions({ breaks: true, gfm: true })

    async function loadArticle() {
      const main = document.getElementById('mainContent')
      const slug = window.location.pathname.split('/').pop()

      try {
        const res = await fetch(`/api/articles/${slug}`)

        if (!res.ok) {
          showError()
          return
        }

        const article = await res.json()

        const siteUrl = window.location.origin
        const articleUrl = `${siteUrl}/article/${article.slug}`
        const description = article.content.substring(0, 160).replace(/[#*_`\n]/g, ' ').trim() + '...'
        const coverImage = article.cover_image || `${siteUrl}/logo-cardynal.png`

        // Update document title
        document.title = `${article.title} - Cardynal`

        // Update meta tags
        document.querySelector('meta[name="description"]').content = description
        document.querySelector('link[rel="canonical"]').href = articleUrl

        // Open Graph
        document.querySelector('meta[property="og:title"]').content = article.title
        document.querySelector('meta[property="og:description"]').content = description
        document.querySelector('meta[property="og:url"]').content = articleUrl
        document.querySelector('meta[property="og:image"]').content = coverImage
        document.querySelector('meta[property="article:published_time"]').content = article.created_at
        document.querySelector('meta[property="article:modified_time"]').content = article.updated_at || article.created_at

        // Twitter Cards
        document.querySelector('meta[name="twitter:title"]').content = article.title
        document.querySelector('meta[name="twitter:description"]').content = description
        document.querySelector('meta[name="twitter:image"]').content = coverImage

        // JSON-LD Article Schema
        document.getElementById('articleSchema').textContent = JSON.stringify({
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": article.title,
          "description": description,
          "image": coverImage,
          "datePublished": article.created_at,
          "dateModified": article.updated_at || article.created_at,
          "mainEntityOfPage": articleUrl,
          "inLanguage": article.lang || "en",
          "author": {
            "@type": "Organization",
            "name": "Cardynal"
          },
          "publisher": {
            "@type": "Organization",
            "name": "Cardynal",
            "url": siteUrl
          }
        })

        // Fetch translations for hreflang tags
        try {
          const transRes = await fetch(`/api/articles/${slug}/translations`)
          const translations = await transRes.json()
          addHreflangTags(translations)
        } catch (e) {
          addHreflangTags([])
        }

        const contentHtml = marked.parse(article.content)
        const locale = currentLang === 'he' ? 'he-IL' : currentLang === 'fr' ? 'fr-FR' : 'en-US'

        main.innerHTML = `
          <div class="article-page-content__inner">
            <article class="article-wrapper">
              ${article.cover_image ? `
                <img src="${article.cover_image}" alt="${escapeHtml(article.title)}" class="article-header__cover">
              ` : ''}
              <div class="article-header">
                <div class="article-header__meta">
                  ${formatDate(article.created_at, locale)}
                  ${article.tags ? ` Â· ${escapeHtml(article.tags)}` : ''}
                </div>
                <h1 class="article-header__title">${escapeHtml(article.title)}</h1>
              </div>
              <div class="article-content">
                ${contentHtml}
              </div>
              <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--landing-border);">
                <a href="/blog.html" class="btn btn--secondary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                  </svg>
                  Back to Blog
                </a>
              </div>
            </article>
          </div>
        `

      } catch (err) {
        showError()
      }
    }

    function showError() {
      const main = document.getElementById('mainContent')
      main.innerHTML = `
        <div class="article-page-content__inner" style="text-align: center; padding: 6rem 2rem;">
          <h2 style="color: var(--landing-text); margin-bottom: 1rem;">Article not found</h2>
          <p style="color: var(--landing-text-muted); margin-bottom: 2rem;">The article you're looking for doesn't exist or has been moved.</p>
          <a href="/blog.html" class="btn btn--primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Blog
          </a>
        </div>
      `
    }

    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }

    function formatDate(dateStr, locale) {
      const date = new Date(dateStr)
      return date.toLocaleDateString(locale, {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      })
    }

    loadArticle()
  </script>
</body>
</html>
